{"version":3,"file":"formCustomisation-44f18b9b.js","sources":["../../../../desk/src/components/CustomActions.vue","../../../../desk/src/composables/formCustomisation.ts"],"sourcesContent":["<template>\n  <div v-if=\"normalActions.length\" class=\"flex gap-2\">\n    <Button\n      v-for=\"action in normalActions\"\n      :key=\"action.label\"\n      :label=\"action.label\"\n      @click=\"action.onClick()\"\n    >\n      <template v-if=\"action.icon\" #prefix>\n        <FeatherIcon :name=\"action.icon\" class=\"h-4 w-4\" />\n      </template>\n    </Button>\n  </div>\n  <Dropdown v-if=\"groupedActions.length\" :options=\"groupedActions\">\n    <Button icon=\"more-horizontal\" />\n  </Dropdown>\n  <div v-if=\"groupedWithLabelActions.length\">\n    <div v-for=\"g in groupedWithLabelActions\" :key=\"g.label\">\n      <Dropdown v-slot=\"{ open }\" :options=\"g.action\">\n        <Button :label=\"g.label\">\n          <template #suffix>\n            <FeatherIcon\n              :name=\"open ? 'chevron-up' : 'chevron-down'\"\n              class=\"h-4\"\n            />\n          </template>\n        </Button>\n      </Dropdown>\n    </div>\n  </div>\n</template>\n\n<script setup>\nimport { computed, h } from \"vue\";\nimport { Dropdown } from \"frappe-ui\";\n\nconst props = defineProps({\n  actions: {\n    type: Object,\n    required: true,\n  },\n});\n\nconst normalActions = computed(() => {\n  return props.actions.filter((action) => !action.group);\n});\n\nconst groupedWithLabelActions = computed(() => {\n  let _actions = [];\n\n  props.actions\n    .filter((action) => action.buttonLabel && action.group)\n    .forEach((action) => {\n      let groupIndex = _actions.findIndex(\n        (a) => a.label === action.buttonLabel\n      );\n      if (groupIndex > -1) {\n        _actions[groupIndex].action.push(action);\n      } else {\n        _actions.push({\n          label: action.buttonLabel,\n          action: [action],\n        });\n      }\n    });\n  return _actions;\n});\n\nconst groupedActions = computed(() => {\n  let _actions = [];\n  _actions = _actions.concat(\n    props.actions.filter((action) => action.group && !action.buttonLabel)\n  );\n  return _actions;\n});\n</script>\n","import { Field } from \"@/types\";\n\nexport async function setupCustomizations(doc, obj) {\n  let data = doc?.data;\n  if (!data) return;\n  if (!data._form_script) return [];\n  let actions = [];\n  let onChangeFieldMap = {};\n  if (Array.isArray(data._form_script)) {\n    for (const script of data._form_script) {\n      const parsed = await parseScript(script, obj);\n      actions = actions.concat(parsed.actions);\n      if (parsed.onChange) {\n        parseOnChangeFn(onChangeFieldMap, parsed.onChange);\n      }\n    }\n  } else {\n    const parsed = await parseScript(data._form_script, obj);\n    actions = parsed.actions;\n    if (parsed.onChange) {\n      parseOnChangeFn(onChangeFieldMap, parsed.onChange);\n    }\n  }\n  data._customActions = actions;\n  if (Object.keys(onChangeFieldMap).length) {\n    data._customOnChange = onChangeFieldMap;\n  }\n}\n\nfunction parseOnChangeFn(fieldMap: object, currentField: object) {\n  for (const [key, value] of Object.entries(currentField)) {\n    if (!fieldMap[key]) {\n      fieldMap[key] = new Set();\n    }\n    fieldMap[key].add(value);\n  }\n}\n\nasync function parseScript(script, obj) {\n  const scriptFn = new Function(script + \"\\nreturn setupForm\")();\n  const formScript = await scriptFn(obj);\n  return {\n    actions: formScript?.actions || [],\n    onChange: formScript?.onChange || null,\n  };\n}\n\nexport function handleSelectFieldUpdate(\n  f: Field,\n  fieldname: string,\n  filters: any,\n  doc: any,\n  oldDoc: any\n) {\n  if (!filters) {\n    f.options = oldDoc.find((f) => f.fieldname === fieldname).options;\n  } else {\n    f.options = filters.join(\"\\n\");\n  }\n\n  // reset dependent field\n  doc[fieldname] = \"\";\n}\n\nexport function handleLinkFieldUpdate(\n  f: Field,\n  fieldname: string,\n  filters: any,\n  doc: any,\n  oldDoc: any\n) {\n  if (!filters) {\n    f.link_filters = oldDoc.find((f) => f.fieldname === fieldname).link_filters;\n    return;\n  }\n  f.link_filters = JSON.stringify([[f.options, \"name\", \"in\", filters]]);\n\n  // reset dependent field\n  doc[fieldname] = \"\";\n}\n\n//\nexport function parseField(field, doc) {\n  return {\n    display_via_depends_on: evaluateDependsOnValue(field?.depends_on, doc),\n    ...field,\n    required:\n      field.required ||\n      (field.mandatory_depends_on &&\n        evaluateDependsOnValue(field.mandatory_depends_on, doc)),\n    filters: field.link_filters && JSON.parse(field.link_filters),\n  };\n}\nfunction evaluateDependsOnValue(expression, doc) {\n  if (!expression) return true;\n  let out = null;\n  if (expression.substr(0, 5) == \"eval:\") {\n    try {\n      out = _eval(expression.substr(5), { doc });\n    } catch (e) {\n      out = true;\n    }\n  } else if (expression.substr(0, 4) == \"doc.\") {\n    out = doc[expression.substr(4)];\n  } else {\n    let value = doc[expression];\n    if (Array.isArray(value)) {\n      out = !!value.length;\n    } else {\n      out = !!value;\n    }\n  }\n  return out;\n}\nfunction _eval(code, context = {}) {\n  let variable_names = Object.keys(context);\n  let variables = Object.values(context);\n  code = `let out = ${code}; return out`;\n  try {\n    let expression_function = new Function(...variable_names, code);\n    return expression_function(...variables);\n  } catch (error) {\n    console.log(\"Error evaluating the following expression:\");\n    console.error(code);\n    throw error;\n  }\n}\n"],"names":["props","__props","normalActions","computed","action","groupedWithLabelActions","_actions","groupIndex","a","groupedActions","_openBlock","_createElementBlock","_hoisted_1","_Fragment","_renderList","_createBlock","_component_Button","$event","_createVNode","_component_FeatherIcon","_unref","Dropdown","_hoisted_2","g","_withCtx","open","setupCustomizations","doc","obj","data","actions","onChangeFieldMap","script","parsed","parseScript","parseOnChangeFn","fieldMap","currentField","key","value","formScript","handleSelectFieldUpdate","f","fieldname","filters","oldDoc","handleLinkFieldUpdate","parseField","field","evaluateDependsOnValue","expression","out","_eval","code","context","variable_names","variables","error"],"mappings":"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"}